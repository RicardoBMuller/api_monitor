<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel AI 2.0 | Intelligent Monitoring</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --bg-deep: #050508;
            --glass-base: rgba(20, 20, 30, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff68;
            --neon-red: #ff0f4b;
            --neon-orange: #ff9100;

            --font-main: 'Outfit', sans-serif;
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }

        body {
            background-color: var(--bg-deep);
            /* Fundo Complexo e Animado */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(188, 19, 254, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 243, 255, 0.08), transparent 25%);
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI COMPONENTS --- */
        
        /* Scrollbar Invisível */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .app-shell {
            max-width: 1800px;
            width: 96%;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 30px 0;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
            animation: fadeInDown 1s var(--ease-elastic);
        }

        h1 {
            font-weight: 200;
            font-size: 2rem;
            letter-spacing: -1px;
            background: linear-gradient(90deg, #fff, var(--text-muted));
            -webkit-background-clip: text;
        }
        h1 b { font-weight: 800; color: var(--neon-blue); text-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

        .toolbar { display: flex; gap: 15px; }

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.9rem;
        }

        .btn-glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: #ccc;
        }
        .btn-glass:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        .btn-glass.active { border-color: var(--neon-green); color: var(--neon-green); box-shadow: 0 0 15px rgba(10, 255, 104, 0.1); }

        .btn-primary {
            background: linear-gradient(135deg, var(--neon-blue), #0062ff);
            color: #000;
            box-shadow: 0 8px 20px rgba(0, 243, 255, 0.25);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 243, 255, 0.4); }

        /* GRID SYSTEM */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 25px;
            overflow-y: auto;
            padding: 10px 10px 50px 10px; /* Padding bottom para scroll */
            flex: 1;
        }

        /* CARD DESIGN (GLASSMORPHISM) */
        .card {
            background: var(--glass-base);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255,255,255,0.15); /* Top highlight */
            border-radius: 20px;
            padding: 25px;
            position: relative;
            transition: all 0.4s var(--ease-elastic);
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.6s var(--ease-elastic);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card:hover {
            transform: translateY(-5px) scale(1.01);
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        /* Card Header */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .meta h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; color: #fff; }
        .meta .url { font-size: 0.75rem; color: #888; font-family: monospace; letter-spacing: 0.5px; }
        
        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 30px;
            background: rgba(0,0,0,0.3);
            border: 1px solid transparent;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Pulse Dot */
        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 0 rgba(255,255,255,0.1); }
        
        /* Status Themes */
        .st-ok .pulse-dot { background: var(--neon-green); animation: pulseGreen 2s infinite; }
        .st-ok { color: var(--neon-green); border-color: rgba(10, 255, 104, 0.2); background: rgba(10, 255, 104, 0.05); }

        .st-warn .pulse-dot { background: var(--neon-orange); }
        .st-warn { color: var(--neon-orange); border-color: rgba(255, 145, 0, 0.2); }

        .st-err .pulse-dot { background: var(--neon-red); animation: pulseRed 1s infinite; }
        .st-err { color: var(--neon-red); border-color: rgba(255, 15, 75, 0.2); background: rgba(255, 15, 75, 0.05); }

        /* Info Row (Latency, Errors) */
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .metric { text-align: left; }
        .metric span { display: block; font-size: 0.7rem; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 2px; }
        .metric b { font-size: 1.1rem; font-weight: 400; }
        
        .metric-err b { color: var(--neon-red); }

        /* Chart Area */
        .chart-container {
            flex: 1;
            min-height: 100px;
            width: 100%;
            position: relative;
        }

        /* Volumetry Chips */
        .chips-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .chip {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            color: #aaa;
            display: flex; gap: 6px;
        }
        .chip b { color: #fff; }
        
        .chip.bad { border: 1px solid rgba(255, 15, 75, 0.3); color: var(--neon-red); background: rgba(255, 15, 75, 0.05); }
        .chip.good { border: 1px solid rgba(10, 255, 104, 0.2); color: var(--neon-green); }

        /* Close Button */
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            opacity: 0; transition: 0.3s;
            background: none; border: none; color: var(--neon-red); cursor: pointer; font-size: 1.2rem;
        }
        .card:hover .close-btn { opacity: 1; }

        /* --- MODAL SYSTEM --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 1000; opacity: 0; pointer-events: none; transition: 0.4s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal {
            background: #0f0f13;
            border: 1px solid var(--glass-border);
            width: 500px;
            padding: 40px;
            border-radius: 24px;
            transform: scale(0.9) translateY(20px);
            transition: 0.4s var(--ease-elastic);
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            position: relative;
            overflow: hidden;
        }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }
        
        /* Modal glow effect */
        .modal::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.05), transparent 60%);
            pointer-events: none;
        }

        .input-group { margin-bottom: 20px; position: relative; z-index: 2; }
        .input-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600; }
        .input-group input {
            width: 100%; padding: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff; font-size: 1rem;
            outline: none; transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--neon-blue); background: rgba(255,255,255,0.05); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }

        .modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; position: relative; z-index: 2; }

        /* TOAST */
        .toast-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; }
        .toast {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: #fff; padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            animation: slideLeft 0.4s var(--ease-elastic), fadeOut 0.5s 4s forwards;
            display: flex; align-items: center; gap: 10px;
        }
        .toast::before { content: ''; width: 8px; height: 8px; border-radius: 50%; }
        .toast.success::before { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .toast.error::before { background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }

        /* ANIMATIONS */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(10, 255, 104, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(10, 255, 104, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 255, 104, 0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 15, 75, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 15, 75, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 15, 75, 0); } }
        @keyframes slideLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); pointer-events: none; } }

    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <h1>Sentinel <b>AI 2.0</b></h1>
            <div class="toolbar">
                <button class="btn btn-glass" id="btnConfig" onclick="openModal('modalConfig')">
                    ⚙️ Configurar Alertas
                </button>
                <button class="btn btn-primary" onclick="openModal('modalAdd')">
                    + Adicionar Monitor
                </button>
            </div>
        </header>

        <div class="monitor-grid" id="grid">
            <div id="empty-state" style="grid-column: 1/-1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; color: #444;">
                <h2 style="font-weight: 200; font-size: 2rem; margin-bottom: 10px;">Sistema em Standby</h2>
                <p>Adicione um monitor para começar a análise.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAdd">
        <div class="modal">
            <h2 style="margin-bottom: 30px; font-weight: 400;">Novo <b style="color:var(--neon-blue)">Alvo</b></h2>
            
            <div class="input-group">
                <label>Nome do Serviço</label>
                <input type="text" id="inpName" placeholder="Ex: Backend Payments">
            </div>
            <div class="input-group">
                <label>URL do Endpoint</label>
                <input type="url" id="inpUrl" placeholder="https://api.system.com/health">
            </div>
            <div class="input-group">
                <label>Intervalo de Checagem (Minutos)</label>
                <input type="number" id="inpInterval" value="1" min="0.1" step="0.1">
            </div>

            <div class="modal-actions">
                <button class="btn btn-glass" onclick="closeModal('modalAdd')">Cancelar</button>
                <button class="btn btn-primary" onclick="addMonitor()">Iniciar Monitoramento</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <h2 style="margin-bottom: 20px; font-weight: 400;">Configurar <b style="color:var(--neon-purple)">EmailJS</b></h2>
            <p style="margin-bottom: 20px; font-size: 0.85rem; color: #888;">
                Necessário para o sistema enviar alertas inteligentes.
            </p>
            
            <div class="input-group">
                <label>Service ID</label>
                <input type="text" id="cfgService">
            </div>
            <div class="input-group">
                <label>Template ID</label>
                <input type="text" id="cfgTemplate">
            </div>
            <div class="input-group">
                <label>Public Key</label>
                <input type="text" id="cfgKey">
            </div>
            <div class="input-group">
                <label>Email de Destino</label>
                <input type="email" id="cfgDest">
            </div>

            <div class="modal-actions">
                <button class="btn btn-glass" onclick="closeModal('modalConfig')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Salvar Credenciais</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // --- CONSTANTES DE IA / LÓGICA ---
        const ALERT_COOLDOWN_MS = 15 * 60 * 1000; // 15 min sem repetir email para a mesma API
        const WINDOW_ANALYSIS_MS = 5 * 60 * 1000; // Janela de 5 min para analise de volumetria
        const FAILURE_THRESHOLD = 0.25; // 25% de erro dispara alerta

        // --- ESTADO ---
        let monitors = JSON.parse(localStorage.getItem('sentinel_v2_monitors')) || [];
        let config = JSON.parse(localStorage.getItem('sentinel_v2_config')) || {
            serviceId: '', templateId: '', publicKey: '', destination: ''
        };
        let charts = {};

        // --- CORE ---
        document.addEventListener('DOMContentLoaded', () => {
            if (config.publicKey) emailjs.init(config.publicKey);
            updateConfigButton();
            renderAll();
            setInterval(monitorLoop, 1000);
        });

        function monitorLoop() {
            const now = Date.now();
            monitors.forEach(m => {
                if (now - m.lastCheck >= (m.interval * 60000)) {
                    pingTarget(m);
                }
            });
        }

        async function pingTarget(m) {
            m.lastCheck = Date.now();
            
            // SIMULAÇÃO DE REDE (Troque por fetch real se CORS permitir)
            const result = await simulateNetwork(m);
            
            // 1. Gravar Histórico (Limitado a 100 pts para performance)
            m.history.push({ x: m.lastCheck, y: result.latency, code: result.code });
            if(m.history.length > 100) m.history.shift();

            // 2. Atualizar Contadores de Volumetria
            if(!m.stats) m.stats = {};
            if(!m.stats[result.code]) m.stats[result.code] = 0;
            m.stats[result.code]++;

            // 3. Lógica de Consecutive Errors (Regra 1)
            if (result.code >= 400) {
                m.consecutiveErrors = (m.consecutiveErrors || 0) + 1;
            } else {
                m.consecutiveErrors = 0; // Reset se sucesso
            }

            saveData();
            updateCard(m, result);
            
            // 4. RODAR ALGORITMO DE ALERTA
            checkSmartAlerts(m, result);
        }

        async function checkSmartAlerts(m, result) {
            const now = Date.now();
            const lastAlert = m.lastAlert || 0;
            
            // Se estiver em cooldown, ignora tudo
            if (now - lastAlert < ALERT_COOLDOWN_MS) return;
            
            let triggerReason = null;

            // REGRA 1: 5 Erros Consecutivos
            if (m.consecutiveErrors >= 5) {
                triggerReason = `CRÍTICO: 5 falhas consecutivas detectadas.`;
            }

            // REGRA 2: Volumetria de 25% em 5 minutos
            if (!triggerReason) {
                const windowStart = now - WINDOW_ANALYSIS_MS;
                const recentPoints = m.history.filter(h => h.x > windowStart);
                
                // Precisamos de pelo menos 4 amostras para não dar alerta falso no inicio
                if (recentPoints.length >= 4) {
                    const errorCount = recentPoints.filter(h => h.code >= 400).length;
                    const failureRate = errorCount / recentPoints.length;
                    
                    if (failureRate >= FAILURE_THRESHOLD) {
                        triggerReason = `ALERTA: Taxa de falha ${(failureRate*100).toFixed(1)}% nos últimos 5 min.`;
                    }
                }
            }

            // DISPARAR ALERTA
            if (triggerReason && config.serviceId) {
                console.log(`Sending Alert: ${triggerReason}`);
                m.lastAlert = now; // Ativa cooldown
                saveData();
                
                sendEmailAlert(m, triggerReason, result);
            }
        }

        async function sendEmailAlert(m, reason, result) {
            showToast(`Enviando alerta: ${m.name}`, 'error');
            try {
                await emailjs.send(config.serviceId, config.templateId, {
                    api_name: m.name,
                    api_url: m.url,
                    message: reason,
                    last_code: result.code,
                    to_email: config.destination
                });
                showToast('Email de alerta enviado com sucesso!', 'success');
            } catch (e) {
                console.error(e);
                showToast('Falha ao enviar email (Verifique Console)', 'error');
            }
        }

        // --- SIMULADOR DE REDE OTIMIZADO ---
        function simulateNetwork(m) {
            return new Promise(resolve => {
                const rand = Math.random();
                let code = 200;
                let latency = Math.floor(Math.random() * 80) + 20;

                // 20% de chance de erro para testar suas regras
                if (rand > 0.8) {
                    code = Math.random() > 0.5 ? 500 : 429;
                    latency += 200;
                }

                setTimeout(() => resolve({ code, latency }), 300);
            });
        }

        // --- RENDERIZAÇÃO ---
        function renderAll() {
            const grid = document.getElementById('grid');
            if (monitors.length === 0) {
                document.getElementById('empty-state').style.display = 'flex';
                return;
            }
            document.getElementById('empty-state').style.display = 'none';
            
            monitors.forEach(m => {
                if(!document.getElementById(`card-${m.id}`)) {
                    createCardDOM(m);
                }
            });
        }

        function createCardDOM(m) {
            const grid = document.getElementById('grid');
            const el = document.createElement('div');
            el.className = 'card';
            el.id = `card-${m.id}`;
            el.innerHTML = `
                <button class="close-btn" onclick="removeMonitor(${m.id})">×</button>
                <div class="card-header">
                    <div class="meta">
                        <h3>${m.name}</h3>
                        <div class="url">${m.url}</div>
                    </div>
                    <div class="status-pill st-warn" id="pill-${m.id}">
                        <div class="pulse-dot"></div>
                        <span id="txt-${m.id}">INIT</span>
                    </div>
                </div>
                
                <div class="info-row">
                    <div class="metric">
                        <span>LATÊNCIA</span>
                        <b id="lat-${m.id}">-- ms</b>
                    </div>
                    <div class="metric">
                        <span>ERROS SEQ.</span>
                        <b id="seq-${m.id}">0</b>
                    </div>
                    <div class="metric">
                        <span>ÚLT. STATUS</span>
                        <b id="code-${m.id}">--</b>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chart-${m.id}"></canvas>
                </div>

                <div class="chips-container" id="chips-${m.id}"></div>
            `;
            grid.appendChild(el);
            initChart(m);
            // Renderiza estado inicial se existir histórico
            if(m.history.length > 0) {
                updateCard(m, m.history[m.history.length-1]);
            }
        }

        function updateCard(m, result) {
            // 1. Atualiza Status Visual
            const pill = document.getElementById(`pill-${m.id}`);
            const txt = document.getElementById(`txt-${m.id}`);
            
            if (result.code >= 500) {
                pill.className = 'status-pill st-err'; txt.innerText = 'CRITICAL';
            } else if (result.code >= 400) {
                pill.className = 'status-pill st-warn'; txt.innerText = 'WARN';
            } else {
                pill.className = 'status-pill st-ok'; txt.innerText = 'HEALTHY';
            }

            // 2. Métricas
            document.getElementById(`lat-${m.id}`).innerText = result.latency + ' ms';
            document.getElementById(`code-${m.id}`).innerText = result.code;
            
            // Cor do contador sequencial
            const seqEl = document.getElementById(`seq-${m.id}`);
            seqEl.innerText = m.consecutiveErrors;
            seqEl.style.color = m.consecutiveErrors > 0 ? 'var(--neon-red)' : '#fff';

            // 3. Volumetria (Chips)
            renderChips(m);

            // 4. Gráfico
            updateChart(m);
        }

        function renderChips(m) {
            const container = document.getElementById(`chips-${m.id}`);
            container.innerHTML = '';
            
            const codes = Object.keys(m.stats).sort();
            codes.forEach(code => {
                const count = m.stats[code];
                const isBad = parseInt(code) >= 400;
                const div = document.createElement('div');
                div.className = `chip ${isBad ? 'bad' : 'good'}`;
                div.innerHTML = `<b>${code}</b> ${count}x`;
                container.appendChild(div);
            });
        }

        // --- CHART.JS CONFIG ---
        function initChart(m) {
            const ctx = document.getElementById(`chart-${m.id}`).getContext('2d');
            
            // Gradiente Vertical no Gráfico
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, 'rgba(0, 243, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(0, 243, 255, 0)');

            charts[m.id] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        data: m.history,
                        borderColor: '#00f3ff',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4,
                        // Linha muda de cor se erro
                        segment: {
                            borderColor: ctx => ctx.p0.raw.code >= 400 ? '#ff0f4b' : '#00f3ff'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 0 }
                    }
                }
            });
        }

        function updateChart(m) {
            if(charts[m.id]) {
                charts[m.id].data.datasets[0].data = m.history;
                charts[m.id].update();
            }
        }

        // --- GERENCIAMENTO ---
        function addMonitor() {
            const name = document.getElementById('inpName').value;
            const url = document.getElementById('inpUrl').value;
            const interval = document.getElementById('inpInterval').value;

            if(name && url) {
                const newM = {
                    id: Date.now(), name, url, interval: parseFloat(interval),
                    lastCheck: 0, consecutiveErrors: 0, lastAlert: 0,
                    history: [], stats: {}
                };
                monitors.push(newM);
                saveData();
                renderAll();
                closeModal('modalAdd');
            }
        }

        function removeMonitor(id) {
            if(confirm('Remover monitor?')) {
                monitors = monitors.filter(m => m.id !== id);
                if(charts[id]) charts[id].destroy();
                document.getElementById(`card-${id}`).remove();
                saveData();
                if(monitors.length === 0) renderAll(); // show empty state
            }
        }

        function saveConfig() {
            config.serviceId = document.getElementById('cfgService').value;
            config.templateId = document.getElementById('cfgTemplate').value;
            config.publicKey = document.getElementById('cfgKey').value;
            config.destination = document.getElementById('cfgDest').value;
            
            localStorage.setItem('sentinel_v2_config', JSON.stringify(config));
            if(config.publicKey) emailjs.init(config.publicKey);
            
            closeModal('modalConfig');
            updateConfigButton();
            showToast('Configurações salvas!', 'success');
        }

        // --- UI HELPERS ---
        function saveData() { localStorage.setItem('sentinel_v2_monitors', JSON.stringify(monitors)); }
        function openModal(id) { document.getElementById(id).classList.add('active'); loadConfigInputs(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function loadConfigInputs() {
            document.getElementById('cfgService').value = config.serviceId;
            document.getElementById('cfgTemplate').value = config.templateId;
            document.getElementById('cfgKey').value = config.publicKey;
            document.getElementById('cfgDest').value = config.destination;
        }

        function updateConfigButton() {
            const btn = document.getElementById('btnConfig');
            if(config.publicKey) btn.classList.add('active');
        }

        function showToast(msg, type) {
            const box = document.createElement('div');
            box.className = `toast ${type}`;
            box.innerText = msg;
            document.getElementById('toastContainer').appendChild(box);
            setTimeout(() => box.remove(), 4500);
        }

    </script>
</body>
</html>
