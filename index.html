<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel NuCel 2.3 | Cyber-Deck Design</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --bg-deep: #050508;
            --glass-base: rgba(18, 18, 28, 0.7);
            --glass-border: rgba(255, 255, 255, 0.06);
            --glass-panel: rgba(255, 255, 255, 0.03);
            
            --neon-blue: #00f3ff;
            --neon-green: #0aff68;
            --neon-red: #ff0f4b;
            --neon-orange: #ff9100;

            --font-main: 'Outfit', sans-serif;
            --ease-out: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }

        body {
            background-color: var(--bg-deep);
            background-image: 
                linear-gradient(to bottom, transparent 80%, rgba(0, 243, 255, 0.03)),
                radial-gradient(circle at 50% -30%, rgba(0, 243, 255, 0.15), transparent 50%);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-shell {
            max-width: 1600px; width: 95%; margin: 0 auto;
            height: 100vh; display: flex; flex-direction: column; padding-top: 30px;
        }

        header {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 35px; padding: 0 10px;
        }

        h1 { font-weight: 200; font-size: 1.8rem; letter-spacing: -1px; }
        h1 b { font-weight: 700; color: var(--neon-blue); text-shadow: 0 0 30px rgba(0, 243, 255, 0.4); }

        .toolbar { display: flex; gap: 12px; }

        .btn {
            border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; transition: all 0.3s var(--ease-out); display: flex; align-items: center; gap: 8px;
        }
        .btn-glass { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: #aaa; }
        .btn-glass:hover { background: rgba(255,255,255,0.08); color: #fff; border-color: rgba(255,255,255,0.2); }
        .btn-glass.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(10, 255, 104, 0.05); }
        .btn-primary { background: linear-gradient(135deg, var(--neon-blue), #0062ff); color: #000; box-shadow: 0 4px 20px rgba(0, 243, 255, 0.2); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0, 243, 255, 0.4); }

        /* --- GRID UNIFORME --- */
        .monitor-grid {
            flex: 1; display: grid;
            /* Cards mais largos e com altura m√≠nima igual */
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            grid-auto-rows: 1fr; /* For√ßa mesma altura na linha */
            align-content: start;
            gap: 25px; overflow-y: auto; padding: 5px 10px 80px 10px;
        }
        .monitor-grid::-webkit-scrollbar { width: 5px; }
        .monitor-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* --- CARD DESIGN V3 (CYBER-DECK) --- */
        .card {
            background: var(--glass-base); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px;
            position: relative; animation: popIn 0.5s var(--ease-out);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); 
            /* Garante altura uniforme e distribui√ß√£o do conte√∫do */
            display: flex; flex-direction: column; min-height: 450px;
        }
        .card::before { /* Top Highlight border */
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        .card:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* HEADER DO CARD REORGANIZADO */
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .meta-col { flex: 1; padding-right: 15px; }
        .meta-col h3 { font-size: 1.1rem; font-weight: 500; color: #fff; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta-col .url { font-size: 0.75rem; color: #777; font-family: monospace; letter-spacing: 0.5px; }
        
        .actions-col { display: flex; align-items: center; gap: 10px; }
        
        /* Status Pill */
        .status-pill {
            padding: 6px 12px; border-radius: 30px; background: rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px; font-size: 0.7rem; font-weight: 700; letter-spacing: 1px;
        }
        .pulse-dot { width: 6px; height: 6px; border-radius: 50%; }
        .st-ok { color: var(--neon-green); border: 1px solid rgba(10, 255, 104, 0.15); }
        .st-ok .pulse-dot { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: pulse 2s infinite; }
        .st-warn { color: var(--neon-orange); border: 1px solid rgba(255, 145, 0, 0.15); }
        .st-warn .pulse-dot { background: var(--neon-orange); }
        .st-err { color: var(--neon-red); border: 1px solid rgba(255, 15, 75, 0.15); }
        .st-err .pulse-dot { background: var(--neon-red); animation: pulseFast 1s infinite; }

        /* Action Buttons (Modernos) */
        .card-icon-btn {
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--glass-border);
            background: var(--glass-panel); color: #888; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
            font-size: 1rem;
        }
        .card-icon-btn:hover { background: rgba(255,255,255,0.08); color: #fff; border-color: rgba(255,255,255,0.3); }
        .card-icon-btn.settings:hover { color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); border-color: var(--neon-blue); }
        .card-icon-btn.delete:hover { color: var(--neon-red); box-shadow: 0 0 15px rgba(255, 15, 75, 0.2); border-color: var(--neon-red); }

        /* Pain√©is de M√©tricas (Flutuantes) */
        .metrics-deck {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px;
        }
        .metric-panel {
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; display: flex; flex-direction: column;
            transition: 0.3s;
        }
        .metric-panel:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.15); }
        .metric-panel span { font-size: 0.65rem; color: #666; font-weight: 700; margin-bottom: 4px; letter-spacing: 0.5px; }
        .metric-panel b { font-size: 1.2rem; font-weight: 500; color: #fff; }

        /* Chart Area (Flex√≠vel) */
        .chart-wrapper { 
            flex: 1; /* Ocupa o espa√ßo restante */
            width: 100%; min-height: 180px; position: relative;
            display: flex; align-items: center; justify-content: center;
        }

        /* Footer Chips */
        .chips-container { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--glass-border); }
        .chip {
            font-size: 0.7rem; padding: 6px 10px; border-radius: 6px; 
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            color: #999; display: flex; gap: 6px; font-weight: 500;
        }
        .chip b { color: #fff; font-weight: 700; }
        .chip.bad { border-color: rgba(255, 15, 75, 0.3); color: var(--neon-red); background: rgba(255, 15, 75, 0.05); }

        /* --- MODALS & TOAST (Estilo mantido, funcionalidade igual) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 1000; opacity: 0; pointer-events: none; transition: 0.4s var(--ease-out); display: flex; align-items: center; justify-content: center; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal { background: #0a0a0f; border: 1px solid var(--glass-border); width: 480px; padding: 35px; border-radius: 24px; box-shadow: 0 40px 80px rgba(0,0,0,0.7); transform: scale(0.92) translateY(20px); transition: 0.4s var(--ease-out); }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }
        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600; }
        .input-group input { width: 100%; padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.02); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }

        /* Chart Options (Modal) */
        .chart-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 25px; }
        .chart-opt-btn { background: var(--glass-panel); border: 1px solid var(--glass-border); padding: 18px; border-radius: 12px; cursor: pointer; color: #777; text-align: center; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .chart-opt-btn:hover { background: rgba(255,255,255,0.06); color: #fff; border-color: rgba(255,255,255,0.2); }
        .chart-opt-btn.selected { border-color: var(--neon-blue); color: var(--neon-blue); background: rgba(0, 243, 255, 0.03); box-shadow: 0 0 20px rgba(0, 243, 255, 0.05); }
        .opt-icon { font-size: 1.8rem; }

        .toast-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; }
        .toast { background: #14141c; border: 1px solid rgba(255,255,255,0.08); color: #fff; padding: 14px 22px; border-radius: 10px; font-size: 0.9rem; animation: slideIn 0.4s var(--ease-out), fadeOut 0.5s 4s forwards; border-left: 4px solid var(--neon-blue); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .toast.error { border-left-color: var(--neon-red); }

        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(10, 255, 104, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(10, 255, 104, 0); } }
        @keyframes pulseFast { 0% { box-shadow: 0 0 0 0 rgba(255, 15, 75, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(255, 15, 75, 0); } }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); pointer-events: none; } }
    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <h1>Sentinel <b>NuCel 2.3</b></h1>
            <div class="toolbar">
                <button class="btn btn-glass" id="btnConfig" onclick="openModal('modalConfig')">‚öôÔ∏è Config Global</button>
                <button class="btn btn-primary" onclick="openModal('modalAdd')">+ Novo Monitor</button>
            </div>
        </header>

        <div class="monitor-grid" id="grid">
            <div id="empty-state" style="grid-column: 1/-1; text-align: center; margin-top: 100px; color: #555; display: flex; flex-direction: column; align-items: center;">
                <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">üõ∞Ô∏è</div>
                <h3 style="font-weight: 300; font-size: 1.5rem; color: #fff;">Dashboard Aguardando</h3>
                <p style="font-size: 0.9rem; margin-top: 10px; max-width: 300px;">Adicione seu primeiro endpoint para iniciar o monitoramento em tempo real.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAdd">
        <div class="modal">
            <h2 style="margin-bottom: 25px; font-weight: 400;">Novo Alvo</h2>
            <div class="input-group"><label>Nome de Identifica√ß√£o</label><input type="text" id="inpName" placeholder="Ex: Microsservi√ßo Pagamentos"></div>
            <div class="input-group"><label>Endpoint URL</label><input type="url" id="inpUrl" placeholder="https://api.seu-sistema.com/health"></div>
            <div class="input-group"><label>Intervalo de Checagem (Minutos)</label><input type="number" id="inpInterval" value="1" step="0.1" min="0.1"></div>
            <div class="modal-actions">
                <button class="btn btn-glass" onclick="closeModal('modalAdd')">Cancelar</button>
                <button class="btn btn-primary" onclick="addMonitor()">Iniciar Monitoramento</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalChart">
        <div class="modal">
            <h2 style="margin-bottom: 10px; font-weight: 400;">Visualiza√ß√£o de Dados</h2>
            <p style="color:#777; font-size: 0.85rem;">Selecione o modo de exibi√ß√£o para este monitor.</p>
            
            <div class="chart-options">
                <div class="chart-opt-btn" onclick="setChartType('line')" id="opt-line">
                    <span class="opt-icon">üìà</span><span>Linha do Tempo</span>
                </div>
                <div class="chart-opt-btn" onclick="setChartType('bar')" id="opt-bar">
                    <span class="opt-icon">üìä</span><span>Barras</span>
                </div>
                <div class="chart-opt-btn" onclick="setChartType('doughnut')" id="opt-doughnut">
                    <span class="opt-icon">üç©</span><span>Distribui√ß√£o (Rosca)</span>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 30px;">
                <button class="btn btn-glass" style="width: 100%; justify-content: center;" onclick="closeModal('modalChart')">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <h2 style="margin-bottom: 25px; font-weight: 400;">Integra√ß√£o EmailJS</h2>
            <div class="input-group"><label>Service ID</label><input type="text" id="cfgService"></div>
            <div class="input-group"><label>Template ID</label><input type="text" id="cfgTemplate"></div>
            <div class="input-group"><label>Public Key</label><input type="text" id="cfgKey"></div>
            <div class="input-group"><label>Email de Destino para Alertas</label><input type="email" id="cfgDest"></div>
            <div class="modal-actions">
                <button class="btn btn-glass" onclick="closeModal('modalConfig')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Salvar Credenciais</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // --- LOGIC CORE (Mesma l√≥gica da V2.2, apenas adaptada ao novo DOM) ---
        const ALERT_COOLDOWN_MS = 15 * 60 * 1000;
        const WINDOW_ANALYSIS_MS = 5 * 60 * 1000; 
        const FAILURE_THRESHOLD = 0.25; 

        let monitors = JSON.parse(localStorage.getItem('sentinel_v2_monitors')) || [];
        let config = JSON.parse(localStorage.getItem('sentinel_v2_config')) || {
            serviceId: '', templateId: '', publicKey: '', destination: ''
        };
        let charts = {};
        let currentEditId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (config.publicKey) emailjs.init(config.publicKey);
            updateConfigButton();
            renderAll();
            setInterval(monitorLoop, 1000);
        });

        function monitorLoop() {
            const now = Date.now();
            monitors.forEach(m => {
                if (now - m.lastCheck >= (m.interval * 60000)) {
                    pingTarget(m);
                }
            });
        }

        async function pingTarget(m) {
            m.lastCheck = Date.now();
            const result = await simulateNetwork(m);
            
            m.history.push({ x: m.lastCheck, y: result.latency, code: result.code });
            if(m.history.length > 50) m.history.shift();

            if(!m.stats) m.stats = {};
            if(!m.stats[result.code]) m.stats[result.code] = 0;
            m.stats[result.code]++;

            if (result.code >= 400) m.consecutiveErrors = (m.consecutiveErrors || 0) + 1;
            else m.consecutiveErrors = 0;

            saveData();
            updateCard(m, result);
            checkSmartAlerts(m, result);
        }

        async function checkSmartAlerts(m, result) {
            const now = Date.now();
            const lastAlert = m.lastAlert || 0;
            if (now - lastAlert < ALERT_COOLDOWN_MS) return;
            
            let triggerReason = null;
            if (m.consecutiveErrors >= 5) triggerReason = `CR√çTICO: 5 falhas consecutivas.`;

            if (!triggerReason) {
                const recentPoints = m.history.filter(h => h.x > (now - WINDOW_ANALYSIS_MS));
                if (recentPoints.length >= 4) {
                    const errorCount = recentPoints.filter(h => h.code >= 400).length;
                    if ((errorCount / recentPoints.length) >= FAILURE_THRESHOLD) {
                        triggerReason = `ALERTA: Alta taxa de falha (25%+)`;
                    }
                }
            }

            if (triggerReason && config.serviceId) {
                m.lastAlert = now;
                saveData();
                sendEmailAlert(m, triggerReason, result);
            }
        }

        async function sendEmailAlert(m, reason, result) {
            showToast(`Disparando alerta: ${m.name}`, 'error');
            try {
                await emailjs.send(config.serviceId, config.templateId, {
                    api_name: m.name, api_url: m.url, message: reason, last_code: result.code, to_email: config.destination
                });
                showToast('Alerta enviado com sucesso!', 'success');
            } catch (e) { console.error(e); }
        }

        function simulateNetwork(m) {
            return new Promise(resolve => {
                const rand = Math.random();
                let code = 200;
                let latency = Math.floor(Math.random() * 50) + 10;
                if (rand > 0.85) { code = Math.random() > 0.5 ? 500 : 429; latency += 150; }
                setTimeout(() => resolve({ code, latency }), 300);
            });
        }

        function openChartModal(id) {
            currentEditId = id;
            const m = monitors.find(x => x.id === id);
            document.querySelectorAll('.chart-opt-btn').forEach(b => b.classList.remove('selected'));
            const currentType = m.chartType || 'line';
            document.getElementById(`opt-${currentType}`).classList.add('selected');
            openModal('modalChart');
        }

        function setChartType(type) {
            if(!currentEditId) return;
            const m = monitors.find(x => x.id === currentEditId);
            if(m) {
                m.chartType = type;
                saveData();
                if(charts[m.id]) { charts[m.id].destroy(); delete charts[m.id]; }
                initChart(m);
                if(m.history.length > 0) updateCard(m, {code: m.history[m.history.length-1].code, latency: m.history[m.history.length-1].y});
                document.querySelectorAll('.chart-opt-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById(`opt-${type}`).classList.add('selected');
                showToast(`Visualiza√ß√£o alterada para ${type}`, 'success');
                closeModal('modalChart');
            }
        }

        // --- RENDER & DOM (NOVO LAYOUT) ---
        function renderAll() {
            const grid = document.getElementById('grid');
            if (monitors.length === 0) { document.getElementById('empty-state').style.display = 'flex'; return; }
            document.getElementById('empty-state').style.display = 'none';
            monitors.forEach(m => { if(!document.getElementById(`card-${m.id}`)) createCardDOM(m); });
        }

        function createCardDOM(m) {
            const grid = document.getElementById('grid');
            const el = document.createElement('div');
            el.className = 'card';
            el.id = `card-${m.id}`;
            // NOVO LAYOUT DO CARD
            el.innerHTML = `
                <div class="card-header-row">
                    <div class="meta-col">
                        <h3>${m.name}</h3>
                        <div class="url">${m.url}</div>
                    </div>
                    <div class="actions-col">
                        <div class="status-pill st-warn" id="pill-${m.id}">
                            <div class="pulse-dot"></div><span id="txt-${m.id}">...</span>
                        </div>
                        <button class="card-icon-btn settings" onclick="openChartModal(${m.id})" title="Visualiza√ß√£o">‚öôÔ∏è</button>
                        <button class="card-icon-btn delete" onclick="removeMonitor(${m.id})" title="Remover">√ó</button>
                    </div>
                </div>

                <div class="metrics-deck">
                    <div class="metric-panel"><span>LAT√äNCIA</span><b id="lat-${m.id}">--</b></div>
                    <div class="metric-panel"><span>ERROS SEQ.</span><b id="seq-${m.id}">0</b></div>
                    <div class="metric-panel"><span>C√ìDIGO</span><b id="code-${m.id}">--</b></div>
                </div>

                <div class="chart-wrapper"><canvas id="chart-${m.id}"></canvas></div>
                <div class="chips-container" id="chips-${m.id}"></div>
            `;
            grid.appendChild(el);
            initChart(m);
            if(m.history.length > 0) updateCard(m, m.history[m.history.length-1]);
        }

        function updateCard(m, result) {
            const pill = document.getElementById(`pill-${m.id}`);
            const txt = document.getElementById(`txt-${m.id}`);
            
            if (result.code >= 500) { pill.className = 'status-pill st-err'; txt.innerText = 'CR√çTICO'; } 
            else if (result.code >= 400) { pill.className = 'status-pill st-warn'; txt.innerText = 'ATEN√á√ÉO'; } 
            else { pill.className = 'status-pill st-ok'; txt.innerText = 'ONLINE'; }

            document.getElementById(`lat-${m.id}`).innerText = result.latency + 'ms';
            document.getElementById(`code-${m.id}`).innerText = result.code;
            const seqEl = document.getElementById(`seq-${m.id}`);
            seqEl.innerText = m.consecutiveErrors;
            seqEl.style.color = m.consecutiveErrors > 0 ? 'var(--neon-red)' : '#fff';

            const chips = document.getElementById(`chips-${m.id}`);
            chips.innerHTML = '';
            Object.keys(m.stats).sort().forEach(code => {
                const isBad = parseInt(code) >= 400;
                chips.innerHTML += `<div class="chip ${isBad?'bad':''}"><b style="color:${isBad?'var(--neon-red)':'#fff'}">${code}</b> ${m.stats[code]}x</div>`;
            });

            if(charts[m.id]) {
                const chart = charts[m.id];
                const type = m.chartType || 'line';
                if (type === 'doughnut') {
                    const codes = Object.keys(m.stats).sort();
                    chart.data.labels = codes;
                    chart.data.datasets[0].data = codes.map(c => m.stats[c]);
                    chart.data.datasets[0].backgroundColor = codes.map(c => parseInt(c)>=500?'#ff0f4b':(parseInt(c)>=400?'#ff9100':'#0aff68'));
                } else {
                    chart.data.datasets[0].data = m.history;
                }
                chart.update('none');
            }
        }

        function initChart(m) {
            const ctx = document.getElementById(`chart-${m.id}`).getContext('2d');
            const type = m.chartType || 'line';
            let config = {};

            if (type === 'doughnut') {
                config = {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, animation: false,
                        // Legenda na parte inferior para economizar espa√ßo lateral
                        plugins: { legend: { position: 'bottom', labels: { color: '#888', font: {size:10}, boxWidth: 10, padding: 15 } } },
                        cutout: '65%', layout: { padding: { top: 10, bottom: 10 } }
                    }
                };
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(0, 243, 255, 0.2)'); gradient.addColorStop(1, 'rgba(0, 243, 255, 0)');
                config = {
                    type: type,
                    data: { datasets: [{
                        data: m.history, borderColor: '#00f3ff', backgroundColor: type === 'bar' ? '#00f3ff' : gradient,
                        borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4, barThickness: 6
                    }]},
                    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
                };
            }
            charts[m.id] = new Chart(ctx, config);
        }

        // --- MANAGERS ---
        function addMonitor() {
            const name = document.getElementById('inpName').value;
            const url = document.getElementById('inpUrl').value;
            const interval = document.getElementById('inpInterval').value;
            if(name && url) {
                monitors.push({
                    id: Date.now(), name, url, interval: parseFloat(interval), chartType: 'line',
                    lastCheck: 0, consecutiveErrors: 0, lastAlert: 0, history: [], stats: {}
                });
                saveData(); renderAll(); closeModal('modalAdd');
            }
        }
        function removeMonitor(id) {
            if(confirm('Tem certeza que deseja remover este monitor?')) {
                monitors = monitors.filter(m => m.id !== id);
                if(charts[id]) charts[id].destroy();
                document.getElementById(`card-${id}`).remove();
                saveData();
                if(monitors.length===0) renderAll();
            }
        }
        function saveConfig() {
            config.serviceId = document.getElementById('cfgService').value;
            config.templateId = document.getElementById('cfgTemplate').value;
            config.publicKey = document.getElementById('cfgKey').value;
            config.destination = document.getElementById('cfgDest').value;
            localStorage.setItem('sentinel_v2_config', JSON.stringify(config));
            if(config.publicKey) emailjs.init(config.publicKey);
            closeModal('modalConfig'); updateConfigButton(); showToast('Configura√ß√µes salvas!', 'success');
        }
        function saveData() { localStorage.setItem('sentinel_v2_monitors', JSON.stringify(monitors)); }
        function openModal(id) { document.getElementById(id).classList.add('active'); if(id==='modalConfig') loadCfg(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function loadCfg() {
            document.getElementById('cfgService').value = config.serviceId;
            document.getElementById('cfgTemplate').value = config.templateId;
            document.getElementById('cfgKey').value = config.publicKey;
            document.getElementById('cfgDest').value = config.destination;
        }
        function updateConfigButton() { if(config.publicKey) document.getElementById('btnConfig').classList.add('active'); }
        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }
    </script>
</body>
</html>
