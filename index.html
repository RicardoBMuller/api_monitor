<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel AI | Dark Enterprise</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* --- THEME CONFIG (DARK NEON) --- */
        :root {
            --bg-deep: #050508;
            --glass-panel: rgba(20, 20, 30, 0.7); /* Painel escuro transl√∫cido */
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            
            --text-main: #ffffff;
            --text-muted: #8b9bb4;

            /* Palette Neon */
            --neon-blue: #00f3ff;
            --neon-green: #0aff68;
            --neon-red: #ff0f4b;
            --neon-orange: #ff9100;
            --neon-purple: #bc13fe;

            --font-main: 'Outfit', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }

        body {
            background-color: var(--bg-deep);
            /* Fundo sutil */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(188, 19, 254, 0.05), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 243, 255, 0.05), transparent 25%);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        h1 { font-weight: 300; font-size: 1.4rem; letter-spacing: 1px; }
        h1 b { font-weight: 700; color: var(--neon-blue); text-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }

        .toolbar { display: flex; gap: 10px; }

        .btn {
            border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.8rem;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        
        .btn-glass { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #ccc; }
        .btn-glass:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        
        .btn-primary { background: linear-gradient(135deg, var(--neon-blue), #0062ff); color: #000; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }
        .btn-primary:hover { box-shadow: 0 0 25px rgba(0, 243, 255, 0.4); }

        /* --- LAYOUT GRID --- */
        .dashboard-grid {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(650px, 1fr)); /* Cards largos estilo dashboard */
            grid-auto-rows: min-content;
            gap: 25px;
            align-content: start;
        }

        /* Scrollbar */
        .dashboard-grid::-webkit-scrollbar { width: 6px; }
        .dashboard-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        /* --- ANALYTICS PANEL (CARD) --- */
        .panel {
            background: var(--glass-panel);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s, border-color 0.3s;
            min-height: 420px;
            animation: fadeIn 0.5s ease-out;
        }
        .panel:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-3px); }

        /* Panel Header */
        .panel-head {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: flex-start;
            background: rgba(255,255,255,0.02);
        }
        .head-info h3 { font-size: 1rem; font-weight: 600; color: #fff; letter-spacing: 0.5px; }
        .head-info .url { font-size: 0.75rem; color: var(--text-muted); font-family: monospace; margin-top: 3px; }

        .head-actions { display: flex; align-items: center; gap: 10px; }
        .status-badge {
            font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 20px;
            background: rgba(0,0,0,0.3); border: 1px solid transparent; letter-spacing: 1px;
        }
        .btn-icon { background: transparent; border: none; color: #666; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .btn-icon:hover { color: var(--neon-red); }

        /* Status Colors */
        .st-ok { color: var(--neon-green); border-color: rgba(10, 255, 104, 0.3); box-shadow: 0 0 10px rgba(10, 255, 104, 0.1); }
        .st-warn { color: var(--neon-orange); border-color: rgba(255, 145, 0, 0.3); }
        .st-err { color: var(--neon-red); border-color: rgba(255, 15, 75, 0.3); box-shadow: 0 0 10px rgba(255, 15, 75, 0.1); }

        /* Panel Body */
        .panel-body {
            padding: 20px;
            flex: 1;
            display: grid;
            /* Layout Grid Interno: 2 colunas (Gr√°fico Tempo maior, Pizza menor) */
            grid-template-columns: 2fr 1fr; 
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        /* KPI Row (Topo) */
        .kpi-row {
            grid-column: 1 / -1;
            display: flex; gap: 40px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        .kpi { display: flex; flex-direction: column; }
        .kpi span { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .kpi b { font-size: 1.8rem; font-weight: 400; color: #fff; }

        /* Chart Containers */
        .chart-area {
            position: relative; width: 100%; height: 200px;
            border-right: 1px solid var(--glass-border); padding-right: 15px;
        }
        .chart-donut {
            position: relative; width: 100%; height: 200px;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- MODALS (Dark Style) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #0f0f13; border: 1px solid var(--glass-border); width: 450px; padding: 30px; border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.7); }
        
        .modal h2 { margin-bottom: 20px; color: #fff; font-weight: 400; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 6px; }
        .input-group input { 
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none;
        }
        .input-group input:focus { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.05); }

        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: #181820; border: 1px solid var(--glass-border);
            color: #fff; padding: 15px 25px; border-radius: 8px; font-size: 0.9rem;
            border-left: 4px solid var(--neon-blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; z-index: 2000;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <header>
        <h1>Sentinel <b>AI Enterprise</b></h1>
        <div class="toolbar">
            <button class="btn btn-glass" onclick="openModal('modalConfig')">‚öôÔ∏è Configura√ß√µes</button>
            <button class="btn btn-primary" onclick="openModal('modalAdd')">+ Novo Monitor</button>
        </div>
    </header>

    <div class="dashboard-grid" id="grid">
        <div id="empty-state" style="grid-column: 1/-1; text-align: center; margin-top: 100px; opacity: 0.5;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üìä</div>
            <h3>Dashboard Vazio</h3>
            <p>Adicione monitores para visualizar as m√©tricas em tempo real.</p>
        </div>
    </div>

    <div class="modal-overlay" id="modalAdd">
        <div class="modal">
            <h2>Adicionar Monitor</h2>
            <div class="input-group"><label>Nome do Servi√ßo</label><input type="text" id="inpName" placeholder="Ex: Backend Checkout"></div>
            <div class="input-group"><label>Endpoint URL</label><input type="url" id="inpUrl" placeholder="https://api..."></div>
            <div class="input-group"><label>Intervalo (Minutos)</label><input type="number" id="inpInterval" value="1" step="0.1"></div>
            <div class="modal-footer">
                <button class="btn btn-glass" onclick="closeModal('modalAdd')">Cancelar</button>
                <button class="btn btn-primary" onclick="addMonitor()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <h2>Configura√ß√µes de Alerta</h2>
            <div class="input-group"><label>Service ID (EmailJS)</label><input type="text" id="cfgService"></div>
            <div class="input-group"><label>Template ID</label><input type="text" id="cfgTemplate"></div>
            <div class="input-group"><label>Public Key</label><input type="text" id="cfgKey"></div>
            <div class="input-group"><label>Email Destino</label><input type="email" id="cfgDest"></div>
            <div class="modal-footer">
                <button class="btn btn-glass" onclick="closeModal('modalConfig')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- LOGIC CORE ---
        const ALERT_COOLDOWN_MS = 15 * 60 * 1000;
        
        let monitors = JSON.parse(localStorage.getItem('sentinel_dark_monitors')) || [];
        let config = JSON.parse(localStorage.getItem('sentinel_dark_config')) || {
            serviceId: '', templateId: '', publicKey: '', destination: ''
        };
        let charts = {};

        document.addEventListener('DOMContentLoaded', () => {
            if (config.publicKey) emailjs.init(config.publicKey);
            renderAll();
            setInterval(monitorLoop, 1500);
        });

        // --- ENGINE ---
        function monitorLoop() {
            const now = Date.now();
            monitors.forEach(m => {
                if (now - m.lastCheck >= (m.interval * 60000)) {
                    pingTarget(m);
                }
            });
        }

        async function pingTarget(m) {
            m.lastCheck = Date.now();
            const result = await simulateNetwork(m);

            m.history.push({ x: m.lastCheck, y: result.latency, code: result.code });
            if (m.history.length > 50) m.history.shift();

            if (!m.stats) m.stats = {};
            if (!m.stats[result.code]) m.stats[result.code] = 0;
            m.stats[result.code]++;
            
            m.totalCalls = (m.totalCalls || 0) + 1;

            if (result.code >= 400) m.consecutiveErrors = (m.consecutiveErrors || 0) + 1;
            else m.consecutiveErrors = 0;

            saveData();
            updatePanel(m, result);
            checkAlerts(m, result);
        }

        // --- RENDER (DARK KIBANA STYLE) ---
        function renderAll() {
            const grid = document.getElementById('grid');
            if (monitors.length === 0) { document.getElementById('empty-state').style.display = 'block'; return; }
            document.getElementById('empty-state').style.display = 'none';
            monitors.forEach(m => { if(!document.getElementById(`panel-${m.id}`)) createPanelDOM(m); });
        }

        function createPanelDOM(m) {
            const grid = document.getElementById('grid');
            const el = document.createElement('div');
            el.className = 'panel';
            el.id = `panel-${m.id}`;
            
            el.innerHTML = `
                <div class="panel-head">
                    <div class="head-info">
                        <h3>${m.name}</h3>
                        <div class="url">${m.url}</div>
                    </div>
                    <div class="head-actions">
                        <div id="badge-${m.id}" class="status-badge st-ok">WAITING</div>
                        <button class="btn-icon" onclick="removeMonitor(${m.id})">√ó</button>
                    </div>
                </div>

                <div class="panel-body">
                    <div class="kpi-row">
                        <div class="kpi">
                            <span>Total Requests</span>
                            <b id="val-total-${m.id}">0</b>
                        </div>
                        <div class="kpi">
                            <span>Latency (ms)</span>
                            <b id="val-lat-${m.id}">--</b>
                        </div>
                        <div class="kpi">
                            <span>Status</span>
                            <b id="val-code-${m.id}" style="color:var(--text-muted)">--</b>
                        </div>
                    </div>

                    <div class="chart-area">
                        <canvas id="chart-time-${m.id}"></canvas>
                    </div>
                    <div class="chart-donut">
                        <canvas id="chart-pie-${m.id}"></canvas>
                    </div>
                </div>
            `;
            grid.appendChild(el);
            initCharts(m);
            if(m.history.length > 0) updatePanel(m, {code: m.history[m.history.length-1].code, latency: m.history[m.history.length-1].y});
        }

        function updatePanel(m, result) {
            // KPIs
            document.getElementById(`val-total-${m.id}`).innerText = m.totalCalls || 0;
            document.getElementById(`val-lat-${m.id}`).innerText = result.latency;
            const codeEl = document.getElementById(`val-code-${m.id}`);
            codeEl.innerText = result.code;
            codeEl.style.color = result.code >= 400 ? 'var(--neon-red)' : 'var(--neon-blue)';

            // Badge
            const badge = document.getElementById(`badge-${m.id}`);
            if (result.code >= 500) { badge.className = 'status-badge st-err'; badge.innerText = 'CRITICAL'; }
            else if (result.code >= 400) { badge.className = 'status-badge st-err'; badge.innerText = 'ERROR'; }
            else { badge.className = 'status-badge st-ok'; badge.innerText = 'HEALTHY'; }

            // Charts
            if(charts[m.id]) {
                const cTime = charts[m.id].time;
                const cPie = charts[m.id].pie;

                // Time Series (Area Chart)
                cTime.data.datasets[0].data = m.history;
                // Cor din√¢mica: Vermelho se erro, Azul Neon se ok
                const mainColor = result.code >= 400 ? '#ff0f4b' : '#00f3ff';
                const fillColor = result.code >= 400 ? 'rgba(255, 15, 75, 0.2)' : 'rgba(0, 243, 255, 0.15)';
                
                cTime.data.datasets[0].borderColor = mainColor;
                cTime.data.datasets[0].backgroundColor = fillColor;
                cTime.update('none');

                // Pie Chart
                const codes = Object.keys(m.stats).sort();
                cPie.data.labels = codes;
                cPie.data.datasets[0].data = codes.map(c => m.stats[c]);
                cPie.data.datasets[0].backgroundColor = codes.map(c => {
                    const code = parseInt(c);
                    if (code >= 500) return '#ff0f4b';
                    if (code >= 400) return '#ff9100';
                    return '#0aff68';
                });
                cPie.update('none');
            }
        }

        function initCharts(m) {
            // Configura√ß√µes Globais Dark Chart.js
            Chart.defaults.color = '#8b9bb4';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

            // 1. Time Chart (Area)
            const ctxTime = document.getElementById(`chart-time-${m.id}`).getContext('2d');
            const timeChart = new Chart(ctxTime, {
                type: 'line',
                data: {
                    datasets: [{
                        data: m.history,
                        borderColor: '#00f3ff',
                        backgroundColor: 'rgba(0, 243, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: 'origin',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });

            // 2. Pie Chart
            const ctxPie = document.getElementById(`chart-pie-${m.id}`).getContext('2d');
            const pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 8, font: {size: 10} } } 
                    },
                    cutout: '65%'
                }
            });

            charts[m.id] = { time: timeChart, pie: pieChart };
        }

        // --- NETWORK SIM & ALERTS ---
        function simulateNetwork(m) {
            return new Promise(resolve => {
                const rand = Math.random();
                let code = 200;
                let latency = Math.floor(Math.random() * 80) + 20;
                if (rand > 0.85) { 
                    code = Math.random() > 0.6 ? 500 : 429; 
                    latency += 250; 
                }
                setTimeout(() => resolve({ code, latency }), 200);
            });
        }

        async function checkAlerts(m, result) {
            const now = Date.now();
            if (now - (m.lastAlert||0) < ALERT_COOLDOWN_MS) return;
            
            let reason = null;
            if (m.consecutiveErrors >= 5) reason = `Falha cont√≠nua detectada (5x Erros)`;
            
            if (reason && config.serviceId) {
                m.lastAlert = now;
                saveData();
                try {
                    await emailjs.send(config.serviceId, config.templateId, {
                        api_name: m.name, message: reason, last_code: result.code, to_email: config.destination
                    });
                    showToast('Alerta enviado!', 'success');
                } catch(e) { console.error(e); }
            }
        }

        // --- MANAGERS ---
        function addMonitor() {
            const name = document.getElementById('inpName').value;
            const url = document.getElementById('inpUrl').value;
            const interval = document.getElementById('inpInterval').value;
            if (name && url) {
                monitors.push({
                    id: Date.now(), name, url, interval: parseFloat(interval),
                    lastCheck: 0, consecutiveErrors: 0, lastAlert: 0, history: [], stats: {}, totalCalls: 0
                });
                saveData(); renderAll(); closeModal('modalAdd');
            }
        }

        function removeMonitor(id) {
            if(confirm('Remover painel?')) {
                monitors = monitors.filter(m => m.id !== id);
                if(charts[id]) { charts[id].time.destroy(); charts[id].pie.destroy(); delete charts[id]; }
                document.getElementById(`panel-${id}`).remove();
                saveData();
                if(monitors.length === 0) renderAll();
            }
        }

        function saveConfig() {
            config.serviceId = document.getElementById('cfgService').value;
            config.templateId = document.getElementById('cfgTemplate').value;
            config.publicKey = document.getElementById('cfgKey').value;
            config.destination = document.getElementById('cfgDest').value;
            localStorage.setItem('sentinel_dark_config', JSON.stringify(config));
            if(config.publicKey) emailjs.init(config.publicKey);
            closeModal('modalConfig'); showToast('Salvo com sucesso!', 'success');
        }

        function saveData() { localStorage.setItem('sentinel_dark_monitors', JSON.stringify(monitors)); }

        // --- UI UTILS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); 
            if(id === 'modalConfig') {
                document.getElementById('cfgService').value = config.serviceId;
                document.getElementById('cfgTemplate').value = config.templateId;
                document.getElementById('cfgKey').value = config.publicKey;
                document.getElementById('cfgDest').value = config.destination;
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

    </script>
</body>
</html>
